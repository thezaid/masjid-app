<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>मस्जिदों के टाईम</title>
    <meta name="description" content="स्थानीय मस्जिदों के लिए अज़ान और जमात के समय की जानकारी।">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+Devanagari:wght@400;500;700&display=swap">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color for Browser UI -->
    <meta name="theme-color" content="#FFFBFE">

    <style>
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary: #625B71;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            --md-sys-color-error: #B3261E;
            --md-sys-color-background: #FFFBFE;
            --md-sys-color-on-background: #1C1B1F;
            --md-sys-color-surface: #FFFBFE;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
        }
        body { font-family: 'Noto Serif Devanagari', sans-serif; background-color: var(--md-sys-color-background); color: var(--md-sys-color-on-background); }
        .top-app-bar { background-color: var(--md-sys-color-surface); }
        .card { background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant); }
        .chip { background-color: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); }
        .btn-primary { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        /* Simple focus visibility for accessibility */
        *:focus-visible { outline: 2px solid var(--md-sys-color-primary); outline-offset: 2px; border-radius: 4px; }
        .search-container input:focus { outline: none; box-shadow: none; }
    </style>
</head>
<body class="antialiased">

    <div id="app-container" class="max-w-2xl mx-auto px-4">
        <!-- Main page content -->
        <div id="main-page">
            <header class="top-app-bar sticky top-0 z-10 w-full shadow-md py-3 px-4 flex items-center justify-between gap-2">
                <h1 class="text-xl font-bold">मस्जिदों के टाईम</h1>
                <div class="flex items-center gap-2">
                    <a href="admin.html" class="p-2 rounded-full hover:bg-gray-200" title="Admin Panel">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-gray-600">
                           <path fill-rule="evenodd" d="M18 8a6 6 0 11-12 0 6 6 0 0112 0zM7 8a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 017 8zM12.25 8.75a.75.75 0 00-1.5 0v1.5a.75.75 0 001.5 0v-1.5z" clip-rule="evenodd" />
                           <path d="M.46 9.049a.75.75 0 01.998-.063 8.49 8.49 0 001.896.755.75.75 0 01-.393 1.454 9.99 9.99 0 01-2.228-.88.75.75 0 01-.273-1.266zM17.728 8.734a.75.75 0 01.273 1.266 9.99 9.99 0 01-2.228.88.75.75 0 11-.393-1.454 8.49 8.49 0 001.896-.755.75.75 0 01.452-.063z" />
                           <path fill-rule="evenodd" d="M10 2a.75.75 0 01.67.41l.223.445.223.445a.75.75 0 01-1.342.67L10 3.527 9.223 5.08a.75.75 0 01-1.342-.67l.223-.445L8.33 3.527a.75.75 0 011.26-.587l.187.374.187.374A.75.75 0 0110 4.09V2zM8.5 14.25a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" />
                        </svg>
                    </a>
                </div>
            </header>

            <main class="py-4">
                <div class="search-container sticky top-[70px] z-10 mb-4 p-1 bg-[var(--md-sys-color-surface-variant)] rounded-full flex items-center shadow">
                    <div class="p-2 text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                    </div>
                    <input type="text" id="search-input" placeholder="मस्जिद, शहर, या टैग खोजें..." class="w-full bg-transparent focus:outline-none pr-3">
                    <button id="filter-btn" class="p-2 rounded-full hover:bg-gray-300 mr-1" title="Filter">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M2.628 1.601C5.028 1.206 7.49 1 10 1s4.973.206 7.372.601a.75.75 0 01.628.74v2.288a2.25 2.25 0 01-.659 1.59l-4.682 4.683a2.25 2.25 0 00-.659 1.59v3.037c0 .684-.31 1.33-.844 1.757l-1.937 1.55A.75.75 0 018 18.25v-5.757a2.25 2.25 0 00-.659-1.59L2.659 6.22A2.25 2.25 0 012 4.629V2.34a.75.75 0 01.628-.74z" /></svg>
                    </button>
                </div>
                <div id="mosque-list" class="space-y-3">
                    <!-- Mosque cards will be inserted here -->
                </div>
                <div id="no-results" class="text-center py-10 hidden">
                    <p>कोई परिणाम नहीं मिला।</p>
                </div>
            </main>
        </div>

        <!-- Detail page content (initially hidden) -->
        <div id="detail-page" class="hidden">
            <!-- Content will be injected here -->
        </div>

    </div>

    <!-- Filter Modal -->
    <div id="filter-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="card w-full max-w-md rounded-2xl shadow-xl p-6">
            <h2 class="text-xl font-bold mb-4">फ़िल्टर करें</h2>
            <div class="space-y-4">
                <div>
                    <h3 class="font-semibold mb-2">शहर के अनुसार</h3>
                    <div id="city-filters" class="flex flex-wrap gap-2"></div>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">टैग के अनुसार</h3>
                    <div id="tag-filters" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button id="clear-filters-btn" class="px-4 py-2 rounded-full font-semibold">साफ़ करें</button>
                <button id="apply-filters-btn" class="btn-primary px-4 py-2 rounded-full font-semibold">लागू करें</button>
            </div>
        </div>
    </div>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Your Supabase credentials
            const SUPABASE_URL = 'https://fbtncgsavafecrljjubv.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZidG5jZ3NhdmFmZWNybGpqdWJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5Njg1ODUsImV4cCI6MjA3MjU0NDU4NX0.vzjeljFGpx276lksHWOOwtJTtvp1WYjbY7SANI3icqs';
            
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            let allMosques = [];
            let uniqueCities = [];
            let uniqueTags = [];
            let activeCityFilters = new Set();
            let activeTagFilters = new Set();

            const mainPage = document.getElementById('main-page');
            const detailPage = document.getElementById('detail-page');
            const mosqueList = document.getElementById('mosque-list');
            const searchInput = document.getElementById('search-input');
            const noResults = document.getElementById('no-results');
            const filterBtn = document.getElementById('filter-btn');
            const filterModal = document.getElementById('filter-modal');
            const cityFiltersContainer = document.getElementById('city-filters');
            const tagFiltersContainer = document.getElementById('tag-filters');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            const applyFiltersBtn = document.getElementById('apply-filters-btn');
            
            // Time formatting function
            function formatLastUpdated(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                const now = new Date();
                const diffSeconds = Math.round((now - date) / 1000);
                const diffMinutes = Math.round(diffSeconds / 60);
                const diffHours = Math.round(diffMinutes / 60);
                const diffDays = Math.round(diffHours / 24);
                
                if (diffSeconds < 60) return `${diffSeconds} सेकंड पहले`;
                if (diffMinutes < 60) return `${diffMinutes} मिनट पहले`;
                if (diffHours < 24) return `${diffHours} घंटे पहले`;
                if (diffDays <= 7) return `${diffDays} दिन पहले`;

                return new Intl.DateTimeFormat('en-IN', {
                    day: 'numeric', month: 'short',
                    hour: 'numeric', minute: '2-digit',
                    hour12: true,
                    timeZone: 'Asia/Kolkata'
                }).format(date);
            }

            function formatTime(timeString) {
                if (!timeString) return '';
                const [hours, minutes] = timeString.split(':');
                const date = new Date();
                date.setHours(hours, minutes, 0);
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            }

            function renderMosqueList(mosques) {
                mosqueList.innerHTML = mosques.map(mosque => `
                    <div class="card p-4 rounded-xl shadow cursor-pointer transition-transform transform hover:scale-105" data-id="${mosque.id}">
                         <div class="flex justify-between items-start">
                             <div>
                                 <h2 class="text-lg font-bold">${mosque.name}</h2>
                                 <p class="text-sm opacity-80">${mosque.city}</p>
                             </div>
                             <p class="text-xs opacity-70 text-right whitespace-nowrap">${formatLastUpdated(mosque.last_updated)}</p>
                         </div>
                    </div>
                `).join('');
                noResults.classList.toggle('hidden', mosques.length > 0);
            }
            
            function filterAndRender() {
                const searchTerm = searchInput.value.toLowerCase();
                const filtered = allMosques.filter(mosque => {
                    const matchesSearch = searchTerm === '' || 
                        mosque.name.toLowerCase().includes(searchTerm) ||
                        mosque.city.toLowerCase().includes(searchTerm) ||
                        (mosque.tag && mosque.tag.toLowerCase().includes(searchTerm));
                    const matchesCity = activeCityFilters.size === 0 || activeCityFilters.has(mosque.city);
                    const matchesTag = activeTagFilters.size === 0 || activeTagFilters.has(mosque.tag);

                    return matchesSearch && matchesCity && matchesTag;
                });
                renderMosqueList(filtered);
            }

            function showDetailPage(mosque) {
                mainPage.classList.add('hidden');
                const prayers = [
                    { name: 'फज्र', azan: mosque.fajr_azan, jamaat: mosque.fajr_jamaat },
                    { name: 'ज़ोहर', azan: mosque.zohar_azan, jamaat: mosque.zohar_jamaat },
                    { name: 'असर', azan: mosque.asr_azan, jamaat: mosque.asr_jamaat },
                    { name: 'मगरिब', azan: mosque.maghrib_azan, jamaat: mosque.maghrib_jamaat },
                    { name: 'ईशा', azan: mosque.isha_azan, jamaat: mosque.isha_jamaat },
                    { name: 'जुमा', azan: mosque.juma_azan, jamaat: mosque.juma_jamaat },
                ];
                
                detailPage.innerHTML = `
                    <header class="top-app-bar sticky top-0 z-10 w-full shadow-md py-3 px-4 flex items-center gap-2">
                        <button id="back-btn" class="p-2 rounded-full hover:bg-gray-200">
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z" clip-rule="evenodd" /></svg>
                        </button>
                        <h1 class="text-xl font-bold truncate">${mosque.name}</h1>
                    </header>
                    <main class="py-4 space-y-6">
                        <div class="px-4">
                           <p class="text-xs text-right opacity-70 mb-2">${formatLastUpdated(mosque.last_updated)}</p>
                           <h1 class="text-2xl font-bold mb-2">${mosque.name}</h1>
                           <div class="flex flex-wrap gap-2 text-sm">
                               <span class="chip font-semibold py-1 px-3 rounded-full">${mosque.city}</span>
                               ${mosque.tag ? `<span class="chip font-semibold py-1 px-3 rounded-full">${mosque.tag}</span>` : ''}
                           </div>
                        </div>

                        <div class="card p-4 rounded-xl">
                            <h2 class="text-xl font-semibold mb-2">नमाज़ो के टाईम</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead class="text-xs text-[var(--md-sys-color-on-surface-variant)] uppercase">
                                        <tr><th class="py-2 px-2">नमाज़</th><th class="py-2 px-2 text-center">अज़ान</th><th class="py-2 px-2 text-center">जमात</th></tr>
                                    </thead>
                                    <tbody>
                                        ${prayers.filter(p => p.azan || p.jamaat).map(p => `
                                            <tr class="border-t border-[var(--md-sys-color-outline)]">
                                                <td class="py-3 px-2 font-medium">${p.name}</td>
                                                <td class="py-3 px-2 text-center font-mono">${formatTime(p.azan)}</td>
                                                <td class="py-3 px-2 text-center font-mono">${formatTime(p.jamaat)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        ${mosque.location ? `
                        <div class="card p-4 rounded-xl">
                            <h2 class="text-xl font-semibold mb-2">वेबसाइट</h2>
                            <a href="${mosque.location}" target="_blank" rel="noopener noreferrer" class="btn-primary inline-block w-full text-center font-bold py-3 px-4 rounded-full transition-transform transform hover:scale-105">वेबसाइट देखें</a>
                        </div>
                        ` : ''}
                        
                        ${mosque.announcement ? `
                        <div class="card p-4 rounded-xl">
                            <h2 class="text-xl font-semibold mb-2">टिप / घोषणा</h2>
                            <p>${mosque.announcement}</p>
                        </div>
                        ` : ''}
                    </main>
                `;
                detailPage.classList.remove('hidden');
                document.getElementById('back-btn').addEventListener('click', () => {
                    detailPage.classList.add('hidden');
                    mainPage.classList.remove('hidden');
                });
            }

            function setupFilterModal() {
                cityFiltersContainer.innerHTML = uniqueCities.map(city => `
                    <button data-value="${city}" class="filter-chip px-3 py-1 rounded-full border border-gray-400 data-[active=true]:bg-[var(--md-sys-color-primary-container)] data-[active=true]:border-[var(--md-sys-color-primary)]">${city}</button>
                `).join('');
                
                tagFiltersContainer.innerHTML = uniqueTags.map(tag => `
                    <button data-value="${tag}" class="filter-chip px-3 py-1 rounded-full border border-gray-400 data-[active=true]:bg-[var(--md-sys-color-primary-container)] data-[active=true]:border-[var(--md-sys-color-primary)]">${tag}</button>
                `).join('');

                cityFiltersContainer.querySelectorAll('.filter-chip').forEach(btn => btn.addEventListener('click', () => {
                    const isActive = btn.dataset.active === 'true';
                    btn.dataset.active = !isActive;
                    if (!isActive) activeCityFilters.add(btn.dataset.value);
                    else activeCityFilters.delete(btn.dataset.value);
                }));
                tagFiltersContainer.querySelectorAll('.filter-chip').forEach(btn => btn.addEventListener('click', () => {
                    const isActive = btn.dataset.active === 'true';
                    btn.dataset.active = !isActive;
                    if (!isActive) activeTagFilters.add(btn.dataset.value);
                    else activeTagFilters.delete(btn.dataset.value);
                }));
            }
            
            async function initializeApp() {
                const { data, error } = await supabase.from('masjids').select('*').order('name');
                if (error) {
                    console.error('Error fetching data:', error);
                    return;
                }
                allMosques = data;
                uniqueCities = [...new Set(data.map(m => m.city).filter(Boolean))].sort();
                uniqueTags = [...new Set(data.map(m => m.tag).filter(Boolean))].sort();
                renderMosqueList(allMosques);
                setupFilterModal();
            }

            // Event Listeners
            searchInput.addEventListener('input', filterAndRender);
            mosqueList.addEventListener('click', (e) => {
                const card = e.target.closest('.card');
                if (card) {
                    const mosqueId = parseInt(card.dataset.id, 10);
                    const selectedMosque = allMosques.find(m => m.id === mosqueId);
                    if (selectedMosque) showDetailPage(selectedMosque);
                }
            });

            filterBtn.addEventListener('click', () => filterModal.classList.remove('hidden'));
            filterModal.addEventListener('click', (e) => {
                if (e.target === filterModal) filterModal.classList.add('hidden');
            });
            clearFiltersBtn.addEventListener('click', () => {
                activeCityFilters.clear();
                activeTagFilters.clear();
                filterModal.querySelectorAll('.filter-chip').forEach(btn => btn.dataset.active = false);
            });
            applyFiltersBtn.addEventListener('click', () => {
                filterAndRender();
                filterModal.classList.add('hidden');
            });
            
            // Real-time listener
            const channel = supabase.channel('public:masjids')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'masjids' }, payload => {
                    console.log('Change received!', payload);
                    initializeApp(); // Re-fetch all data on any change
                })
                .subscribe();

            initializeApp();
        });
    </script>
</body>
</html>

